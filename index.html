<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Carte des salles - PRO MAX</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

<style>
body, html { margin:0; padding:0; font-family:Arial; height:100%; }
#app { display:flex; height:100vh; }
#map { flex:1; }

#filters {
  width:320px;
  background:#fff;
  padding:15px;
  overflow-y:auto;
  border-left:1px solid #ddd;
}

h3 { margin:10px 0 5px; font-size:15px; }
input { width:100%; padding:6px; margin-bottom:10px; border:1px solid #ccc; }
label { display:block; font-size:13px; cursor:pointer; margin-bottom:4px; }

button {
  margin:3px 3px 6px 0;
  padding:5px 8px;
  font-size:12px;
  cursor:pointer;
}

#counter {
  font-size:13px;
  font-weight:bold;
  margin:10px 0;
  color:#333;
}

/* MOBILE */
@media (max-width:768px) {
  #app { flex-direction:column; }
  #filters {
    width:100%;
    max-height:40vh;
    border-left:none;
    border-top:1px solid #ddd;
  }
  #map { height:60vh; }
}
</style>
</head>
<body>

<div id="app">
  <div id="map"></div>

  <div id="filters">
    <h3>Recherche</h3>
    <input type="text" id="searchInput" placeholder="Nom, ville, code postal...">

    <div>
      <button onclick="resetFilters()">Reset filtres</button>
      <button onclick="viewFrance()">Vue France</button>
    </div>

    <div id="counter">Salles visibles : 0</div>

    <h3>Pays</h3>
    <button onclick="checkAll('country', true)">Tout cocher</button>
    <button onclick="checkAll('country', false)">Tout d√©cocher</button>
    <div id="countryFilters"></div>

    <h3>R√©gions (France)</h3>
    <button onclick="checkAll('region', true)">Tout cocher</button>
    <button onclick="checkAll('region', false)">Tout d√©cocher</button>
    <div id="regionFilters"></div>

    <h3>D√©partements</h3>
    <button onclick="checkAll('dept', true)">Tout cocher</button>
    <button onclick="checkAll('dept', false)">Tout d√©cocher</button>
    <div id="deptFilters"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRavscAmLL9ZPZiwxwRzsmsuCEDvcja-YAgg5F2vzAb5gHpUHVyJmCYKD2ONIBPdmwgBfjMg_Ayf3o8/gviz/tq?tqx=out:json";

const map = L.map('map').setView([47.5, 6], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

let cluster = L.markerClusterGroup();
const markers = [];

fetch(sheetURL)
.then(res => res.text())
.then(text => {
  const lines = text.split("\n").slice(1);

  const countries = new Set();
  const regions = new Set();
  const depts = new Set();

  lines.forEach(line => {
    const cols = line.split("\t");

    const name = cols[0] || "";
    const city = cols[1] || "";
    const zip = cols[2] || "";
    const mapLink = cols[4] || "";
    const lat = parseFloat(cols[5]);
    const lng = parseFloat(cols[6]);
    const contact = cols[8] || "";
    const contactLink = cols[9] || "";
    const country = cols[10] || "France";
    const region = cols[11] || "Autre";

    if (!lat || !lng) return;

    const dept = zip.substring(0,2);

    countries.add(country);
    if (country === "France") regions.add(region);
    if (country === "France") depts.add(dept);

    const marker = L.marker([lat, lng]).bindPopup(`
      <strong>${name}</strong><br>
      ${zip} ${city}<br><br>
      <a href="${mapLink}" target="_blank">üìç Adresse</a><br>
      <a href="${contactLink}" target="_blank">üì© Contact</a><br>
      <em>${contact}</em>
    `);

    marker.data = { name, city, zip, country, region, dept };

    markers.push(marker);
    cluster.addLayer(marker);
  });

  map.addLayer(cluster);
  createFilters([...countries], [...regions], [...depts]);
  updateCounter(markers.length);
});

function createFilters(countries, regions, depts) {
  const cDiv = document.getElementById("countryFilters");
  const rDiv = document.getElementById("regionFilters");
  const dDiv = document.getElementById("deptFilters");

  countries.sort().forEach(c => {
    cDiv.innerHTML += `<label><input type="checkbox" checked value="${c}" class="country"> ${c}</label>`;
  });

  regions.sort().forEach(r => {
    rDiv.innerHTML += `<label><input type="checkbox" checked value="${r}" class="region"> ${r}</label>`;
  });

  depts.sort().forEach(d => {
    dDiv.innerHTML += `<label><input type="checkbox" checked value="${d}" class="dept"> ${d}</label>`;
  });

  document.querySelectorAll("input").forEach(i => {
    i.addEventListener("input", applyFilters);
  });
}

function applyFilters() {
  const search = document.getElementById("searchInput").value.trim().toLowerCase();

  const activeCountries = [...document.querySelectorAll(".country:checked")].map(i => i.value);
  const activeRegions = [...document.querySelectorAll(".region:checked")].map(i => i.value);
  const activeDepts = [...document.querySelectorAll(".dept:checked")].map(i => i.value);

  map.removeLayer(cluster);
  cluster = L.markerClusterGroup();

  let visible = 0;

  markers.forEach(marker => {
    const d = marker.data;

    const matchSearch =
      d.name.toLowerCase().includes(search) ||
      d.city.toLowerCase().includes(search) ||
      d.zip.toLowerCase().includes(search);

    const matchCountry =
      activeCountries.length === 0 || activeCountries.includes(d.country);

    const matchRegion =
      d.country !== "France" ||
      activeRegions.length === 0 ||
      activeRegions.includes(d.region);

    const matchDept =
      d.country !== "France" ||
      activeDepts.length === 0 ||
      activeDepts.includes(d.dept);

    if (matchSearch && matchCountry && matchRegion && matchDept) {
      cluster.addLayer(marker);
      visible++;
    }
  });

  map.addLayer(cluster);
  updateCounter(visible);
}


  map.addLayer(cluster);
  updateCounter(visible);
}

function updateCounter(n) {
  document.getElementById("counter").innerText = `Salles visibles : ${n}`;
}

function checkAll(type, state) {
  document.querySelectorAll("." + type).forEach(cb => cb.checked = state);

  if (type === "country" && state === true) {
    document.querySelectorAll(".region").forEach(cb => cb.checked = true);
    document.querySelectorAll(".dept").forEach(cb => cb.checked = true);
  }

  applyFilters();
}

function resetFilters() {
  document.getElementById("searchInput").value = "";
  document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = true);
  applyFilters();
}

function viewFrance() {
  map.setView([46.5, 2.5], 6);
}
</script>

</body>
</html>
