<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Carte des salles</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body, html {
  margin: 0;
  padding: 0;
  font-family: Arial;
  height: 100%;
}

#app {
  display: flex;
  height: 100vh;
  width: 100vw;
}

#map {
  flex: 1;
}

#filters {
  width: 320px;
  background: #ffffff;
  padding: 15px;
  overflow-y: auto;
  border-left: 1px solid #ddd;
}

#filters h3 {
  margin: 10px 0 5px;
  font-size: 15px;
}

#filters input[type="text"] {
  width: 100%;
  padding: 6px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
}

label {
  display: block;
  font-size: 13px;
  cursor: pointer;
  margin-bottom: 4px;
}
</style>
</head>
<body>

<div id="app">
  <div id="map"></div>

  <div id="filters">
    <h3>Recherche</h3>
    <input type="text" id="searchInput" placeholder="Nom, ville, code postal...">

    <h3>Pays</h3>
    <div id="countryFilters"></div>

    <h3>R√©gions</h3>
    <div id="regionFilters"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1eihI2oIaFrH1-ro00QpUz_pGqMpG95-uh4Xy0hXwkC8/gviz/tq?tqx=out:json";

const map = L.map('map').setView([48.8566, 2.3522], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

const markers = [];

function formatLink(url) {
  if (!url) return "#";
  if (url.startsWith("http")) return url;
  return "https://" + url;
}

async function getLocationInfo(lat, lng) {
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
  const data = await res.json();

  return {
    country: data.address.country || "Inconnu",
    region: data.address.state || "Inconnue"
  };
}

fetch(sheetURL)
  .then(res => res.text())
  .then(async text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const rows = json.table.rows;

    const countries = new Set();
    const regions = new Set();

    for (const r of rows) {
      const name = r.c[0]?.v || "";
      const city = r.c[1]?.v || "";
      const zip = r.c[2]?.v || "";
      const addressLink = r.c[4]?.v || "";
      const lat = r.c[5]?.v;
      const lng = r.c[6]?.v;
      const contact = r.c[8]?.v || "";
      const link = r.c[9]?.v || "";

      if (!lat || !lng) continue;

      const geo = await getLocationInfo(lat, lng);

      countries.add(geo.country);
      regions.add(geo.region);

      const marker = L.marker([lat, lng]).bindPopup(`
        <strong>${name}</strong><br>
        ${zip} ${city}<br><br>
        <a href="${formatLink(addressLink)}" target="_blank">üìç Voir l'adresse</a><br>
        <a href="${formatLink(link)}" target="_blank">üì© Contact</a><br><br>
        <em>${contact}</em>
      `);

      marker.data = {
        name, city, zip,
        country: geo.country,
        region: geo.region
      };

      markers.push(marker);
      marker.addTo(map);
    }

    createFilters([...countries], [...regions]);
  });

function createFilters(countries, regions) {
  const countryDiv = document.getElementById("countryFilters");
  const regionDiv = document.getElementById("regionFilters");

  countries.sort().forEach(c => {
    countryDiv.innerHTML += `
      <label><input type="checkbox" checked value="${c}" class="countryFilter"> ${c}</label>
    `;
  });

  regions.sort().forEach(r => {
    regionDiv.innerHTML += `
      <label><input type="checkbox" checked value="${r}" class="regionFilter"> ${r}</label>
    `;
  });

  document.querySelectorAll("input").forEach(i => {
    i.addEventListener("input", applyFilters);
  });
}

function applyFilters() {
  const search = document.getElementById("searchInput").value.toLowerCase();

  const activeCountries = [...document.querySelectorAll(".countryFilter:checked")].map(i => i.value);
  const activeRegions = [...document.querySelectorAll(".regionFilter:checked")].map(i => i.value);

  markers.forEach(marker => {
    const d = marker.data;

    const matchSearch =
      d.name.toLowerCase().includes(search) ||
      d.city.toLowerCase().includes(search) ||
      d.zip.toLowerCase().includes(search);

    const matchCountry = activeCountries.includes(d.country);
    const matchRegion = activeRegions.includes(d.region);

    if (matchSearch && matchCountry && matchRegion) {
      marker.addTo(map);
    } else {
      map.removeLayer(marker);
    }
  });
}
</script>

</body>
</html>
