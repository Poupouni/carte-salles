<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Carte des salles de concert</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<style>
html, body { margin:0; height:100%; font-family: Arial, sans-serif; }
#app { display:flex; height:100vh; }
#map { flex:1; }

#sidebar {
  width:320px;
  background:#f5f5f5;
  padding:12px;
  overflow:auto;
  border-left:1px solid #ccc;
}

h3 { margin-top:15px; }

input, button {
  width:100%;
  padding:6px;
  margin-bottom:6px;
}

.filter-group label {
  display:flex;
  align-items:center;
  gap:6px;
}

#count {
  font-weight:bold;
  margin:10px 0;
}

@media (max-width:768px){
  #app { flex-direction:column; }
  #sidebar { width:100%; height:40%; }
  #map { height:60%; }
}
</style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <div id="sidebar">
    <h3>Recherche</h3>
    <input id="search" placeholder="Nom, ville, code postal">

    <button onclick="resetFilters()">Reset filtres</button>
    <button onclick="vueFrance()">Vue France</button>

    <div id="count">Salles : 0</div>

    <h3>Pays</h3>
    <button onclick="checkAll('country', true)">Tout cocher</button>
    <button onclick="checkAll('country', false)">Tout décocher</button>
    <div id="countryFilters" class="filter-group"></div>

    <h3>Régions (France)</h3>
    <button onclick="checkAll('region', true)">Tout cocher</button>
    <button onclick="checkAll('region', false)">Tout décocher</button>
    <div id="regionFilters" class="filter-group"></div>

    <h3>Départements</h3>
    <button onclick="checkAll('dept', true)">Tout cocher</button>
    <button onclick="checkAll('dept', false)">Tout décocher</button>
    <div id="deptFilters" class="filter-group"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRavscAmLL9ZPZiwxwRzsmsuCEDvcja-YAgg5F2vzAb5gHpUHVyJmCYKD2ONIBPdmwgBfjMg_Ayf3o8/pub?output=csv";

const map = L.map("map").setView([46.5, 2], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const cluster = L.markerClusterGroup();
map.addLayer(cluster);

let markers = [];
let allData = [];

const regionColors = {
  "Bretagne": "blue",
  "Île-de-France": "red",
  "Auvergne-Rhône-Alpes": "green",
  "Occitanie": "orange",
  "Nouvelle-Aquitaine": "purple",
  "Provence-Alpes-Côte d'Azur": "violet",
  "Grand Est": "darkgreen",
  "Hauts-de-France": "cadetblue",
  "Normandie": "teal",
  "Pays de la Loire": "darkblue",
  "Centre-Val de Loire": "brown",
  "Bourgogne-Franche-Comté": "black"
};

function getIcon(region){
  const color = regionColors[region] || "blue";
  return L.icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
    shadowUrl: "https://unpkg.com/leaflet/dist/images/marker-shadow.png",
    iconSize:[25,41], iconAnchor:[12,41]
  });
}

fetch(sheetURL)
.then(r => r.text())
.then(text => {
  const rows = text.split("\n").slice(1);

  rows.forEach(r => {
    const c = r.split(",");

    const data = {
      name: c[0],
      city: c[1],
      zip: c[2],
      lat: parseFloat(c[5]),
      lng: parseFloat(c[6]),
      country: c[10],
      region: c[11],
      dept: c[12] || ""
    };

    if(!data.lat || !data.lng) return;

    allData.push(data);

    const marker = L.marker([data.lat, data.lng], { icon:getIcon(data.region) });
    marker.data = data;
    marker.bindPopup(`<b>${data.name}</b><br>${data.city}<br>${data.region}`);
    markers.push(marker);
  });

  buildFilters();
  applyFilters();
});

function buildFilters(){
  buildGroup("country", "countryFilters", d=>d.country);
  buildGroup("region", "regionFilters", d=>d.region);
  buildGroup("dept", "deptFilters", d=>d.dept);
}

function buildGroup(type, containerId, keyFn){
  const values = [...new Set(allData.map(keyFn).filter(Boolean))].sort();
  const box = document.getElementById(containerId);

  values.forEach(v=>{
    const id = type+"_"+v.replace(/\s/g,"_");
    box.innerHTML += `
      <label>
        <input type="checkbox" class="${type}" value="${v}" checked onchange="applyFilters()">
        ${v}
      </label>`;
  });
}

function applyFilters(){
  cluster.clearLayers();
  const search = document.getElementById("search").value.toLowerCase();

  const active = {
    country: getChecked("country"),
    region: getChecked("region"),
    dept: getChecked("dept")
  };

  let visible = 0;

  markers.forEach(m=>{
    const d = m.data;

    const matchSearch =
      d.name.toLowerCase().includes(search) ||
      d.city.toLowerCase().includes(search) ||
      d.zip.includes(search);

    const match =
      matchSearch &&
      active.country.includes(d.country) &&
      active.region.includes(d.region) &&
      active.dept.includes(d.dept);

    if(match){
      cluster.addLayer(m);
      visible++;
    }
  });

  document.getElementById("count").innerText = "Salles : " + visible;
}

function getChecked(type){
  return [...document.querySelectorAll("."+type+":checked")].map(e=>e.value);
}

function checkAll(type, state){
  document.querySelectorAll("."+type).forEach(cb=>cb.checked = state);
  applyFilters();
}

function resetFilters(){
  ["country","region","dept"].forEach(t=>checkAll(t,true));
  document.getElementById("search").value="";
  applyFilters();
}

function vueFrance(){
  map.setView([46.5,2],6);
}

document.getElementById("search").addEventListener("input", applyFilters);
</script>
</body>
</html>
