<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Concert Map â€” Clean & Stable</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

<style>
html,body{margin:0;height:100%;font-family:system-ui;background:#f5f5f7}
#map{height:100vh}

#ui{
  position:absolute;top:20px;left:20px;
  width:300px;
  background:white;
  border-radius:20px;
  padding:16px;
  box-shadow:0 20px 40px rgba(0,0,0,.25);
  z-index:1000;
}

input,select,button{
  width:100%;padding:10px;margin-bottom:8px;
  border-radius:10px;border:none;background:#eee
}

button{background:#007aff;color:white;font-weight:700;cursor:pointer}
.row{display:flex;gap:8px}
.row button{flex:1}

.stats{text-align:center;font-weight:800}
</style>
</head>

<body>

<div id="ui">
  <h3>ðŸŽµ Concert Map</h3>

  <input id="search" placeholder="Nom, ville, code postal">

  <select id="type">
    <option value="all">Tous les lieux</option>
    <option value="festival">Festivals</option>
    <option value="club">Clubs</option>
    <option value="bar">Bars</option>
    <option value="thÃ©Ã¢tre">ThÃ©Ã¢tres</option>
    <option value="salle">Salles</option>
  </select>

  <div class="row">
    <button id="geo">Autour de moi</button>
  </div>

  <div class="stats" id="count">Lieux : 0</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const SHEET="https://docs.google.com/spreadsheets/d/e/2PACX-1vT2-8LzIag6O728CHEJiDJe6qiDXaQ4hKJ7ddcyM_Z-r9_Wde39xX0_R7o9dn45VU500uFMacVkN-JJ/pub?output=tsv";

/* MAP */
const map=L.map("map").setView([46.8,2.5],4);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ICONS */
const green=L.icon({
  iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png",
  iconSize:[32,32]
});
const red=L.icon({
  iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",
  iconSize:[32,32]
});

/* CLUSTER */
const clusterGroup=L.markerClusterGroup({
  disableClusteringAtZoom:13,
  showCoverageOnHover:false
});
map.addLayer(clusterGroup);

/* DATA */
let markers=[];

/* ULTRA STRICT FILTER (ANTI ZOO / DISNEY) */
const allowed=["concert","music","live","festival","club","theatre","thÃ©Ã¢tre","bar","venue","salle"];

/* LOAD */
fetch(SHEET).then(r=>r.text()).then(t=>{
  const rows=t.replace(/\r/g,"").split("\n").slice(1);

  rows.forEach(r=>{
    const c=r.split("\t");

    const name=c[0];
    const city=c[1];
    const zip=c[2];
    const lat=parseFloat(c[4]);
    const lon=parseFloat(c[5]);
    const type=(c[6]||"").toLowerCase();

    if(!lat||!lon||!name) return;

    // ðŸ§¹ GROS MÃ‰NAGE
    if(
      !allowed.some(k=>type.includes(k)) &&
      !allowed.some(k=>name.toLowerCase().includes(k))
    ) return;

    const isFestival=name.toLowerCase().includes("festival");

    const popup=`
      <b>${name}</b><br>
      ${city||""} ${zip||""}<br>
      ${type}
    `;

    const m=L.marker([lat,lon],{icon:isFestival?red:green})
      .bindPopup(popup);

    m.data={name,city,zip,type};
    markers.push(m);
  });

  apply();
});

/* FILTER */
function apply(){
  clusterGroup.clearLayers();

  const q=search.value.toLowerCase();
  const t=type.value;

  let visible=0;

  markers.forEach(m=>{
    const d=m.data;

    const textMatch=
      d.name.toLowerCase().includes(q)||
      (d.city||"").toLowerCase().includes(q)||
      (d.zip||"").toLowerCase().includes(q);

    const typeMatch=
      t==="all"||d.type.includes(t)||d.name.toLowerCase().includes(t);

    if(textMatch&&typeMatch){
      visible++;
      clusterGroup.addLayer(m);
    }
  });

  count.innerText="Lieux : "+visible;
}

search.oninput=apply;
type.onchange=apply;

/* GEO */
let circle=null;
geo.onclick=()=>{
  if(circle){
    map.removeLayer(circle);
    circle=null;
    geo.innerText="Autour de moi";
    return;
  }

  navigator.geolocation.getCurrentPosition(p=>{
    const {latitude,longitude}=p.coords;
    map.setView([latitude,longitude],12);
    circle=L.circle([latitude,longitude],{
      radius:5000,
      color:"#007aff"
    }).addTo(map);
    geo.innerText="DÃ©sactiver";
  });
};
</script>

</body>
</html>
