<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Carte des salles</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

<style>
html, body { height: 100%; margin: 0; }
#app { display: flex; height: 100vh; }
#map { flex: 1; }
#filters {
  width: 320px;
  padding: 10px;
  overflow-y: auto;
  background: #fff;
  border-left: 1px solid #ccc;
  font-family: Arial, sans-serif;
}
input { width: 100%; padding: 6px; margin-bottom: 10px; }
button { margin: 3px 0; width: 100%; }
label { display: flex; justify-content: space-between; }
@media (max-width: 768px) {
  #filters { position: absolute; right: 0; height: 100%; z-index: 1000; }
}
</style>
</head>

<body>

<div id="app">
  <div id="map"></div>

  <div id="filters">
    <h3>Recherche</h3>
    <input type="text" id="searchInput" placeholder="Nom, ville, code postal">

    <button onclick="resetFilters()">Reset filtres</button>
    <button onclick="viewFrance()">Vue France</button>

    <p id="count">Salles visibles : 0</p>

    <h3>Pays</h3>
    <button onclick="checkAll('country', true)">Tout cocher</button>
    <button onclick="checkAll('country', false)">Tout décocher</button>
    <div id="countryFilters"></div>

    <h3>Régions (France)</h3>
    <button onclick="checkAll('region', true)">Tout cocher</button>
    <button onclick="checkAll('region', false)">Tout décocher</button>
    <div id="regionFilters"></div>

    <h3>Départements</h3>
    <button onclick="checkAll('dept', true)">Tout cocher</button>
    <button onclick="checkAll('dept', false)">Tout décocher</button>
    <div id="deptFilters"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRavscAmLL9ZPZiwxwRzsmsuCEDvcja-YAgg5F2vzAb5gHpUHVyJmCYKD2ONIBPdmwgBfjMg_Ayf3o8/gviz/tq?tqx=out:json";

const map = L.map('map').setView([46.5, 2.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let cluster = L.markerClusterGroup();
let markers = [];

fetch(sheetURL)
  .then(r => r.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const rows = json.table.rows;

    const countries = new Set();
    const regions = new Set();
    const depts = new Set();

    rows.forEach(r => {
      const name = r.c[0]?.v || "";
      const city = r.c[1]?.v || "";
      const zip = r.c[2]?.v || "";
      const lat = r.c[5]?.v;
      const lng = r.c[6]?.v;
      const country = r.c[10]?.v || "Inconnu";
      const region = r.c[11]?.v || "Inconnue";
      const dept = r.c[12]?.v || "Inconnu";

      if (!lat || !lng) return;

      const marker = L.marker([lat, lng]);
      marker.bindPopup(`<b>${name}</b><br>${city} ${zip}`);

      marker.data = { name, city, zip, country, region, dept };

      markers.push(marker);
      cluster.addLayer(marker);

      countries.add(country);
      if (country === "France") {
        regions.add(region);
        depts.add(dept);
      }
    });

    map.addLayer(cluster);
    buildFilters("countryFilters", countries, "country");
    buildFilters("regionFilters", regions, "region");
    buildFilters("deptFilters", depts, "dept");

    applyFilters();
  });

function buildFilters(container, values, cls) {
  const div = document.getElementById(container);
  values.forEach(v => {
    const label = document.createElement("label");
    label.innerHTML = `${v} <input type="checkbox" class="${cls}" value="${v}" checked>`;
    div.appendChild(label);
  });
}

function applyFilters() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const activeCountries = [...document.querySelectorAll(".country:checked")].map(i => i.value);
  const activeRegions = [...document.querySelectorAll(".region:checked")].map(i => i.value);
  const activeDepts = [...document.querySelectorAll(".dept:checked")].map(i => i.value);

  cluster.clearLayers();
  let visible = 0;

  markers.forEach(m => {
    const d = m.data;

    const matchSearch =
      d.name.toLowerCase().includes(search) ||
      d.city.toLowerCase().includes(search) ||
      d.zip.toLowerCase().includes(search);

    const matchCountry = activeCountries.length === 0 || activeCountries.includes(d.country);
    const matchRegion = d.country !== "France" || activeRegions.length === 0 || activeRegions.includes(d.region);
    const matchDept = d.country !== "France" || activeDepts.length === 0 || activeDepts.includes(d.dept);

    if (matchSearch && matchCountry && matchRegion && matchDept) {
      cluster.addLayer(m);
      visible++;
    }
  });

  document.getElementById("count").innerText = `Salles visibles : ${visible}`;
}

function checkAll(type, state) {
  document.querySelectorAll("." + type).forEach(cb => cb.checked = state);
  applyFilters();
}

function resetFilters() {
  document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = true);
  document.getElementById("searchInput").value = "";
  applyFilters();
}

function viewFrance() {
  map.setView([46.5, 2.5], 6);
}

document.getElementById("searchInput").addEventListener("input", applyFilters);
document.addEventListener("change", applyFilters);
</script>

</body>
</html>
