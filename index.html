<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Carte des salles de concert - France</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

<style>
:root {
  --bg: #0b0f1a;
  --panel: rgba(20,24,38,0.95);
  --text: white;
  --input: #1c2033;
  --blue: #2563eb;
}

.light {
  --bg: #f4f6fb;
  --panel: white;
  --text: #0b0f1a;
  --input: #f1f5f9;
}

body, html {
  margin: 0;
  height: 100%;
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

#map { height: 100vh; }

#panel {
  position: absolute;
  top: 16px;
  right: 16px;
  background: var(--panel);
  backdrop-filter: blur(10px);
  padding: 18px;
  width: 320px;
  z-index: 1000;
  border-radius: 18px;
  box-shadow: 0 20px 50px rgba(0,0,0,.5);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#panel input {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: var(--input);
  color: var(--text);
}

button {
  width: 100%;
  padding: 10px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  background: var(--blue);
  color: white;
}

button.small {
  font-size: 12px;
  padding: 8px;
}

#counter {
  text-align: center;
  font-weight: bold;
  margin-top: 6px;
}

.filter-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

@media (max-width: 768px) {
  #panel {
    width: 100%;
    bottom: 0;
    top: auto;
    border-radius: 20px 20px 0 0;
  }
  #map { height: 60vh; }
}
</style>
</head>

<body>

<div id="panel">
  <h3>ðŸŽµ Salles de concerts</h3>

  <input id="search" placeholder="Nom, ville, code postal">

  <div class="filter-group">
    <button class="small" id="all">Tout</button>
    <button class="small" id="festivals">Festivals</button>
    <button class="small" id="venues">Salles</button>
    <button class="small" id="clubs">Clubs</button>
    <button class="small" id="theatres">ThÃ©Ã¢tres</button>
  </div>

  <button id="toggleCluster">Regroupement : ON</button>
  <button id="nearMe">Autour de moi</button>
  <button id="themeToggle">Mode clair / sombre</button>

  <div id="counter">Salles : 0</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// ------------------ MAP SETUP ------------------
const map = L.map("map").setView([0, 0], 2);
const darkTiles = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
const lightTiles = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
let tileLayer = L.tileLayer(darkTiles).addTo(map);

setTimeout(() => map.flyTo([46.8, 2.5], 6, { duration: 1.5 }), 500);

// ------------------ CLUSTER ------------------
let clusteringEnabled = true;
const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 12 });

// ------------------ DATA ------------------
let markers = [];
let activeType = "all";

// ------------------ ICONS ------------------
function icon(color) {
  return L.divIcon({
    html: `<div style="width:16px;height:16px;background:${color};border-radius:50%;border:3px solid white"></div>`
  });
}

const colors = {
  festival: "#ef4444",
  venue: "#22c55e",
  club: "#3b82f6",
  theatre: "#a855f7"
};

// ------------------ ADD MARKER ------------------
function addMarker(lat, lng, name, city, type) {
  const m = L.marker([lat, lng], { icon: icon(colors[type]) })
    .bindPopup(`<b>${name}</b><br>${city}<br>${type}`);

  m.type = type;
  m.name = name.toLowerCase();
  markers.push(m);
  cluster.addLayer(m);
}

// ------------------ GOOGLE SHEET ------------------
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRavscAmLL9ZPZiwxwRzsmsuCEDvcja-YAgg5F2vzAb5gHpUHVyJmCYKD2ONIBPdmwgBfjMg_Ayf3o8/pub?gid=1916022294&single=true&output=tsv")
.then(r => r.text())
.then(text => {
  const rows = text.replace(/\r/g,"").split("\n").slice(1);

  rows.forEach(r => {
    const c = r.split("\t");
    const name = c[0];
    const city = c[1];
    const lat = parseFloat(c[5]?.replace(",","."));
    const lng = parseFloat(c[6]?.replace(",","."));

    if (!lat || !lng) return;

    const type = /festival/i.test(name) ? "festival" : "venue";
    addMarker(lat, lng, name, city, type);
  });

  loadOSM();
});

// ------------------ OPENSTREETMAP ------------------
function loadOSM() {
  const query = `
  [out:json][timeout:25];
  area["name"="France"]->.a;
  (
    node["amenity"="theatre"](area.a);
    node["amenity"="music_venue"](area.a);
    node["amenity"="arts_centre"](area.a);
    node["leisure"="stadium"](area.a);
  );
  out center tags;
  `;

  fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: query
  })
  .then(r => r.json())
  .then(data => {
    data.elements.forEach(el => {
      const name = el.tags?.name || "Lieu musical";
      const city = el.tags?.addr_city || "France";
      const lat = el.lat;
      const lng = el.lon;

      let type = "venue";
      if (/festival/i.test(name)) type = "festival";
      else if (/club|live/i.test(name)) type = "club";
      else if (/theatre|scÃ¨ne/i.test(name)) type = "theatre";

      addMarker(lat, lng, name, city, type);
    });

    map.addLayer(cluster);
    updateCounter();
  });
}

// ------------------ FILTERS ------------------
function applyFilters() {
  cluster.clearLayers();

  const q = document.getElementById("search").value.toLowerCase();
  let count = 0;

  markers.forEach(m => {
    const matchType = activeType === "all" || m.type === activeType;
    const matchText = m.name.includes(q);

    if (matchType && matchText) {
      cluster.addLayer(m);
      count++;
    }
  });

  updateCounter(count);
}

function updateCounter(n = markers.length) {
  document.getElementById("counter").textContent = "Salles : " + n;
}

// ------------------ BUTTONS ------------------
document.getElementById("all").onclick = () => { activeType="all"; applyFilters(); }
document.getElementById("festivals").onclick = () => { activeType="festival"; applyFilters(); }
document.getElementById("venues").onclick = () => { activeType="venue"; applyFilters(); }
document.getElementById("clubs").onclick = () => { activeType="club"; applyFilters(); }
document.getElementById("theatres").onclick = () => { activeType="theatre"; applyFilters(); }

document.getElementById("search").addEventListener("input", applyFilters);

document.getElementById("toggleCluster").onclick = () => {
  clusteringEnabled = !clusteringEnabled;
  map.removeLayer(cluster);

  if (clusteringEnabled) {
    map.addLayer(cluster);
  } else {
    markers.forEach(m => m.addTo(map));
  }

  document.getElementById("toggleCluster").textContent =
    clusteringEnabled ? "Regroupement : ON" : "Regroupement : OFF";
};

document.getElementById("nearMe").onclick = () => {
  navigator.geolocation.getCurrentPosition(p => {
    map.setView([p.coords.latitude, p.coords.longitude], 12);
  });
};

document.getElementById("themeToggle").onclick = () => {
  document.body.classList.toggle("light");
  map.removeLayer(tileLayer);
  tileLayer = L.tileLayer(
    document.body.classList.contains("light") ? lightTiles : darkTiles
  ).addTo(map);
};
</script>

</body>
</html>
